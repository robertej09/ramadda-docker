name: Docker Image CI

# on:
#   push:
#     branches: [ master ]
#   pull_request:
#     branches: [ master ]
#

# Leave out specific branches so this same workflow can be used on any branch
on: [ push, pull_request ]

jobs:

  buildAndTest:
    runs-on: ubuntu-latest
    steps:
      # Checkout the commit that triggered the workflow
    - uses: actions/checkout@v2

    - name: Create image name and tag
      run: |
        REG="espinoza09"
        IMAGE="espinoza_test"
        TAG=${{ github.ref }}
        TAG=${TAG##*/}

    - name: Build the Docker image
      run: |
        echo docker build --no-cache -t ${REG}/${IMAGE}:${TAG} .
        docker build --no-cache -t ${REG}/${IMAGE}:${TAG} .

    - name: Run the container
      run: |
        docker run --name ramadda \
        -v $(pwd)/.github/testScripts:/testScripts \
        -d \
        -p 8080:8080 \
        ${REG}/${IMAGE}:${TAG}

    # Give chance for RAMADDA to fire up
    - name: Wait and listen for RAMADDA to fire up
      run: nc -z -w300 127.0.0.1 8080

    - run: |
        for i in {1..5}; do curl -o /dev/null http://127.0.0.1:8080/repository/ && break || \
        (echo sleeping 15... && sleep 15); done

    - name: Run test script
      run: ./.github/testScripts/test.sh

    - name: Push to Dockerhub
#      if: push or merge
      # The echo of the secrets here is just for testing purposes, should output
      # "username" and "password"
      run: |
        SERVER="https://index.docker.io/v1"
        USERNAME=${{ secrets.registryuser }}
        PWD=${{ secrets.registrypwd }}
        echo ${PWD} | docker login ${SERVER} -u ${USERNAME} --password-stdin
        docker push ${IMAGE}:${TAG}
        docker logout && echo Successfully logged out of Docker registry

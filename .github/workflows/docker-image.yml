name: Docker Image CI
env:
  reg: "espinoza09"
  image: "espinoza_test"
  ref: ${{ github.ref }}

# Leave out specific branches so this same workflow can be used on any branch
on: [ push, pull_request ]

jobs:

  buildAndTest:
    runs-on: ubuntu-latest
    steps:

    - name: Set environment variables
      run: |
        echo "reg=espinoza09" >> $GITHUB_ENV
        echo "image=espinoza_test" >> $GITHUB_ENV
        tag=${{ github.ref }} && tag=${tag##*/}
        echo "tag=${tag}" >> $GITHUB_ENV

      # Checkout the commit that triggered the workflow
    - uses: actions/checkout@v2

    - name: Build the Docker image
      run: |
        echo Build command: docker build --no-cache -t ${{ env.reg }}/${{ env.image }}:${{ env.tag }} .
        docker build --no-cache -t ${{ env.reg }}/${{ env.image }}:${{ env.tag }} .

    - name: Run the container
      run: |
        docker run --name ramadda \
        -v $(pwd)/.github/testScripts:/testScripts \
        -d \
        -p 8080:8080 \
        ${{ env.reg }}/${{ env.image }}:${{ env.tag }}

    # Give chance for RAMADDA to fire up
    - name: Wait and listen for RAMADDA to fire up
      run: nc -z -w300 127.0.0.1 8080

    - run: |
        for i in {1..5}; do curl -o /dev/null http://127.0.0.1:8080/repository/ && break || \
        (echo sleeping 15... && sleep 15); done

    - name: Run test script
      run: ./.github/testScripts/test.sh

    - name: Push to Dockerhub
#      if: push or merge
      # The echo of the secrets here is just for testing purposes, should output
      # "username" and "password"
      run: |
        SERVER="https://index.docker.io/v1"
        USERNAME=${{ secrets.registryuser }}
        PWD=${{ secrets.registrypwd }}
        docker logout
        echo ${PWD} | docker login ${SERVER} -u ${USERNAME} --password-stdin
        echo docker push ${{ env.reg }}/${{ env.image }}:${{ env.tag }}
        docker push espinoza09/espinoza_test:actions
        docker logout && echo Successfully logged out of Docker registry
